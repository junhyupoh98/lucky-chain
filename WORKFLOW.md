# Lucky Chain V2 워크플로우

## 🔄 전체 개발 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 초기 설정                              │
│                                                              │
│  git clone + checkout branch                                │
│              ↓                                               │
│      ./setup-local.sh                                        │
│              ↓                                               │
│  ✅ Foundry 설치                                             │
│  ✅ 의존성 설치                                              │
│  ✅ 컴파일 & 테스트                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
        ┌────────────────┴────────────────┐
        ↓                                  ↓
┌──────────────────┐            ┌──────────────────┐
│  2A. 로컬 개발    │            │  2B. 테스트넷     │
└──────────────────┘            └──────────────────┘
        ↓                                  ↓
```

---

## 💻 로컬 개발 워크플로우

```
┌─────────────────────────────────────────────────────────────┐
│                    터미널 1: Anvil                           │
│                                                              │
│  cd contracts                                                │
│  anvil                                                       │
│                                                              │
│  ✅ 로컬 블록체인 시작 (Chain ID: 31337)                     │
│  ✅ 10개 테스트 계정 생성 (각 10,000 ETH)                    │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                터미널 2: 로컬 배포                            │
│                                                              │
│  ./deploy-local.sh                                           │
│                                                              │
│  Step 1: Mock USDT 배포 → 0xAAA...                          │
│  Step 2: Mock USDC 배포 → 0xBBB...                          │
│  Step 3: LottoV2 배포   → 0xCCC...                          │
│  Step 4: .env.local 자동 생성                                │
│  Step 5: adminConfig.ts 생성                                 │
│                                                              │
│  ✅ 모든 주소 자동 설정                                       │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│              터미널 3: 프론트엔드                             │
│                                                              │
│  cd frontend                                                 │
│  npm run dev                                                 │
│                                                              │
│  ✅ http://localhost:3000 실행                               │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                  MetaMask 설정                               │
│                                                              │
│  1. 네트워크 추가: Localhost 8545                            │
│  2. 개인키 가져오기: 0xac09...                               │
│  3. 지갑 연결                                                │
│                                                              │
│  ✅ 1000 USDT/USDC 보유                                      │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                    테스트                                    │
│                                                              │
│  1. USDT/USDC 선택                                           │
│  2. 티켓 수량 선택                                           │
│  3. 토큰 승인                                                │
│  4. 티켓 구매                                                │
│  5. 구매 내역 확인                                           │
│                                                              │
│  ✅ 전체 플로우 작동 확인                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 🌐 테스트넷 배포 워크플로우

```
┌─────────────────────────────────────────────────────────────┐
│              Step 1: 테스트넷 KAIA 받기                      │
│                                                              │
│  https://faucet.kaia.io/ 방문                                │
│              ↓                                               │
│  지갑 주소 입력 → KAIA 받기                                  │
│                                                              │
│  ✅ 배포 및 테스트용 KAIA 확보                                │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│         Step 2: Mock 토큰 배포 (선택사항)                    │
│                                                              │
│  ./deploy-mock-tokens-testnet.sh                             │
│              ↓                                               │
│  Mock USDT 배포 → 0xDDD...                                   │
│  Mock USDC 배포 → 0xEEE...                                   │
│              ↓                                               │
│  1000 USDT/USDC 민팅                                         │
│                                                              │
│  ✅ 테스트용 토큰 준비 완료                                   │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│            Step 3: 환경 변수 설정                            │
│                                                              │
│  cd contracts                                                │
│  nano .env                                                   │
│                                                              │
│  필수 입력:                                                  │
│  - PRIVATE_KEY=0x...                                         │
│  - USDT_ADDRESS=0x...                                        │
│  - USDC_ADDRESS=0x...                                        │
│  - TREASURY_ADDRESS=0x...                                    │
│                                                              │
│  ✅ 배포 설정 완료                                           │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│            Step 4: 테스트넷 배포                             │
│                                                              │
│  cd ..                                                       │
│  ./deploy-testnet.sh                                         │
│                                                              │
│  1. 환경 변수 검증                                           │
│  2. 컴파일 & 테스트                                          │
│  3. LottoV2 배포 → 0xFFF...                                  │
│  4. .env.local 자동 생성                                     │
│  5. 프론트엔드 빌드                                          │
│                                                              │
│  ✅ 테스트넷 배포 완료                                        │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│          Step 5: Chainlink VRF 설정                          │
│                                                              │
│  https://vrf.chain.link/ 방문                                │
│              ↓                                               │
│  1. Kaia Kairos 네트워크 선택                                │
│  2. 구독 생성 또는 기존 구독 사용                            │
│  3. LottoV2 주소를 컨슈머로 추가                             │
│  4. LINK 토큰 충전 (최소 5 LINK)                             │
│                                                              │
│  ✅ VRF 랜덤 번호 생성 준비 완료                              │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│            Step 6: 관리자 설정                               │
│                                                              │
│  nano frontend/lib/adminConfig.ts                            │
│                                                              │
│  export const allowedAdminAddresses = [                      │
│      '0x당신의_주소',                                        │
│  ];                                                          │
│                                                              │
│  ✅ 관리자 권한 설정 완료                                     │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│            Step 7: 프론트엔드 실행                           │
│                                                              │
│  cd frontend                                                 │
│  npm run dev                                                 │
│                                                              │
│  또는 프로덕션 배포:                                         │
│  vercel --prod                                               │
│                                                              │
│  ✅ 프론트엔드 접근 가능                                      │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                Step 8: 전체 테스트                           │
│                                                              │
│  1. MetaMask를 Kaia Kairos로 전환                            │
│  2. 지갑 연결                                                │
│  3. USDT/USDC 승인                                           │
│  4. 티켓 구매                                                │
│  5. 관리자 페이지 테스트 (/admin)                            │
│  6. 회차 진행 테스트                                         │
│  7. 당첨 번호 추첨 테스트                                    │
│                                                              │
│  ✅ 전체 시스템 작동 확인                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 사용자 플로우

### 일반 사용자 (티켓 구매)

```
┌──────────────┐
│ 메인 페이지   │
│ 접속         │
└──────┬───────┘
       ↓
┌──────────────┐
│ 지갑 연결     │
│ (MetaMask)   │
└──────┬───────┘
       ↓
┌──────────────┐
│ 토큰 선택     │
│ USDT/USDC    │
└──────┬───────┘
       ↓
┌──────────────┐
│ 수량 선택     │
│ (1-10장)     │
└──────┬───────┘
       ↓
┌──────────────┐
│ 토큰 승인     │
│ (최초 1회)   │
└──────┬───────┘
       ↓
┌──────────────┐
│ 티켓 구매     │
│ 확인         │
└──────┬───────┘
       ↓
┌──────────────┐
│ 구매 완료     │
│ 내역 확인    │
└──────────────┘
```

### 관리자 (회차 관리)

```
┌──────────────┐
│ /admin       │
│ 페이지 접속  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 관리자 확인   │
│ (주소 검증)  │
└──────┬───────┘
       ↓
┌──────────────────────────────────┐
│         회차 관리                 │
│                                  │
│  1. 판매 기간 종료               │
│  2. 당첨 번호 추첨 (VRF)         │
│  3. 당첨금 정산                  │
│  4. 다음 회차 시작               │
└──────────────────────────────────┘
```

---

## 🔄 컨트랙트 상태 전환

```
┌─────────────────┐
│   OPEN          │  ← 판매 중
│   (판매 기간)    │
└────────┬────────┘
         ↓ 관리자: 판매 종료
┌─────────────────┐
│   CLOSED        │  ← 판매 종료
│   (추첨 대기)    │
└────────┬────────┘
         ↓ 관리자: 당첨 번호 추첨
┌─────────────────┐
│   DRAWING       │  ← VRF 요청 중
│   (추첨 중)      │
└────────┬────────┘
         ↓ Chainlink VRF 응답
┌─────────────────┐
│   DRAWN         │  ← 당첨 번호 확정
│   (정산 대기)    │
└────────┬────────┘
         ↓ 관리자: 당첨금 정산
┌─────────────────┐
│   SETTLED       │  ← 정산 완료
│   (회차 종료)    │
└────────┬────────┘
         ↓ 관리자: 다음 회차 시작
┌─────────────────┐
│   OPEN          │  ← 새 회차 시작
│   (판매 기간)    │
└─────────────────┘
```

---

## 📊 데이터 흐름

### 티켓 구매 플로우

```
사용자
  ↓ 1. 토큰 승인 (USDT/USDC → LottoV2)
프론트엔드
  ↓ 2. buyTickets(tokenType, amount)
LottoV2 컨트랙트
  ↓ 3. transferFrom(user, contract, $1 * amount)
  ↓ 4. 자동 번호 생성 (온체인)
  ↓ 5. 티켓 ID 발급
  ↓ 6. 이벤트 발생: TicketPurchased
프론트엔드
  ↓ 7. 이벤트 수신 및 UI 업데이트
사용자
  ↓ 8. 구매 내역 확인
```

### 당첨 번호 추첨 플로우

```
관리자
  ↓ 1. 당첨 번호 추첨 버튼 클릭
프론트엔드
  ↓ 2. drawWinningNumbers()
LottoV2 컨트랙트
  ↓ 3. Chainlink VRF 요청
  ↓ 4. 이벤트 발생: RandomnessRequested
Chainlink VRF
  ↓ 5. 랜덤 번호 생성
  ↓ 6. fulfillRandomWords() 호출
LottoV2 컨트랙트
  ↓ 7. 당첨 번호 저장
  ↓ 8. 이벤트 발생: WinningNumbersDrawn
프론트엔드
  ↓ 9. 당첨 번호 표시
```

---

## 🛠️ 개발 사이클

```
┌─────────────┐
│ 코드 수정    │
└──────┬──────┘
       ↓
┌─────────────┐
│ forge test  │  ← 테스트 실행
└──────┬──────┘
       ↓
   테스트 통과?
       ↓ Yes
┌─────────────┐
│ 로컬 배포    │  ← deploy-local.sh
└──────┬──────┘
       ↓
┌─────────────┐
│ 프론트엔드   │  ← npm run dev
│ 테스트      │
└──────┬──────┘
       ↓
   작동 확인?
       ↓ Yes
┌─────────────┐
│ git commit  │
└──────┬──────┘
       ↓
┌─────────────┐
│ 테스트넷    │  ← deploy-testnet.sh
│ 배포        │
└──────┬──────┘
       ↓
┌─────────────┐
│ 전체 테스트  │
└──────┬──────┘
       ↓
   문제 없음?
       ↓ Yes
┌─────────────┐
│ PR 생성     │
└─────────────┘
```

---

## 📝 체크리스트

### 로컬 개발 시작 전
- [ ] Git 저장소 클론
- [ ] V2 브랜치 체크아웃
- [ ] `setup-local.sh` 실행
- [ ] Foundry 설치 확인

### 로컬 배포 전
- [ ] Anvil 실행 중
- [ ] 컨트랙트 컴파일 성공
- [ ] 테스트 통과 (7/7)

### 테스트넷 배포 전
- [ ] 테스트넷 KAIA 확보
- [ ] USDT/USDC 주소 확인
- [ ] `.env` 파일 설정
- [ ] 개인키 안전 확인

### 배포 후
- [ ] 컨트랙트 주소 확인
- [ ] Chainlink VRF 설정
- [ ] 관리자 주소 설정
- [ ] 프론트엔드 빌드 성공
- [ ] 전체 플로우 테스트

---

**이 워크플로우를 따라 진행하면 Lucky Chain V2를 성공적으로 설정하고 배포할 수 있습니다!**
